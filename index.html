<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rider Telemetry Dashboard</title>
<!-- Leaflet & Chart.js CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  /* --- Base styles --- */
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #141e30, #243b55);
    color: #e0e6f0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 2rem 1rem;
  }
  h1 {
    font-weight: 700;
    font-size: 2.75rem;
    color: #6fb3ff;
    margin-bottom: 1.5rem;
    text-shadow: 0 0 12px #419fffaa;
  }

  /* --- Container for metrics --- */
  .metrics {
    display: flex;
    flex-wrap: wrap;
    max-width: 1000px;
    gap: 24px;
    justify-content: center;
    margin-bottom: 2rem;
  }
  .card {
    background: rgba(255 255 255 / 0.07);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 1.8rem 2.5rem;
    min-width: 140px;
    flex-grow: 1;
    box-shadow: 0 8px 20px -6px #3e7deef5;
    text-align: center;
    color: #a3c2ff;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  .card:hover {
    transform: translateY(-6px);
    box-shadow: 0 18px 40px -8px #5fa2fff5;
  }
  .card .value {
    font-size: 2.7rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-shadow: 0 0 10px #6aa0ffbb;
    margin-bottom: 0.3rem;
  }
  .card .label {
    font-size: 1.1rem;
    font-weight: 600;
    color: #a6b3c9cc;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  /* --- Map styling --- */
  #map {
    width: 90vw;
    max-width: 1000px;
    height: 480px;
    border-radius: 22px;
    box-shadow: 0 12px 35px -4px #447ffcbb;
    border: 1px solid #376cdd88;
    margin-bottom: 2.5rem;
  }

  /* --- Chart canvas --- */
  #accChart {
    background: rgba(20, 30, 50, 0.85);
    width: 90vw !important;
    max-width: 1000px !important;
    height: 320px !important;
    border-radius: 16px;
    box-shadow: 0 12px 35px -6px #3f89ffbb;
  }

  /* --- GPS & Heading info --- */
  .geo-info {
    max-width: 1000px;
    width: 90vw;
    display: flex;
    justify-content: space-around;
    gap: 32px;
    margin: 2rem 0 1rem 0;
    color: #a1b9f8;
    font-weight: 600;
    font-size: 1.15rem;
    user-select: text;
  }
  .geo-info div {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .geo-info svg {
    width: 24px;
    height: 24px;
    fill: #719feccc;
    flex-shrink: 0;
  }

  /* --- Loading message --- */
  #loadingMsg {
    color: #719fecaa;
    font-weight: 500;
    font-style: italic;
    margin: 1rem 0;
    user-select: none;
  }

  /* --- Responsive for smaller devices --- */
  @media (max-width: 660px) {
    h1 {
      font-size: 2rem;
    }
    .metrics {
      gap: 18px;
    }
    .card {
      min-width: 120px;
      padding: 1.3rem 1.8rem;
    }
  }
</style>
</head>
<body>
  <h1>Rider Telemetry Dashboard</h1>

  <section class="metrics" aria-label="Rider telemetry key metrics" role="list">
    <article class="card" role="listitem" aria-live="polite" aria-atomic="true">
      <div class="value" id="speedDisplay">0 km/h</div>
      <div class="label">Speed</div>
    </article>
    <article class="card" role="listitem" aria-live="polite" aria-atomic="true">
      <div class="value" id="leanDisplay">0°</div>
      <div class="label">Lean Angle</div>
    </article>
    <article class="card" role="listitem" aria-live="polite" aria-atomic="true">
      <div class="value" id="accXDisplay">0.00</div>
      <div class="label">Accel X (m/s²)</div>
    </article>
    <article class="card" role="listitem" aria-live="polite" aria-atomic="true">
      <div class="value" id="accYDisplay">0.00</div>
      <div class="label">Accel Y (m/s²)</div>
    </article>
    <article class="card" role="listitem" aria-live="polite" aria-atomic="true">
      <div class="value" id="accZDisplay">0.00</div>
      <div class="label">Accel Z (m/s²)</div>
    </article>
  </section>

  <canvas id="accChart" aria-label="Acceleration chart over time" role="img" tabindex="0"></canvas>

  <section class="geo-info" aria-live="polite" aria-atomic="true" role="region" aria-label="Current GPS coordinates and compass heading">
    <div title="Latitude" aria-label="Latitude">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zM12 11.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5 14.5 7.62 14.5 9 13.38 11.5 12 11.5z"/></svg>
      <span id="latDisplay">Lat: 0.00000</span>
    </div>
    <div title="Longitude" aria-label="Longitude">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>
      <span id="lonDisplay">Lon: 0.00000</span>
    </div>
    <div title="Compass heading" aria-label="Compass heading">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2L15 8.5 22 9 17 14 18 21 12 18 6 21 7 14 2 9 9 8.5z"/></svg>
      <span id="compassDisplay">Heading: 0°</span>
    </div>
  </section>

  <div id="map" role="region" aria-label="Live GPS map"></div>
  <div id="loadingMsg">Connecting to rider sensor...</div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const url = prompt("Enter your Phyphox JSON Live URL (e.g., http://192.168.1.34:8080)");

    const map = L.map('map').setView([0, 0], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 19,
    }).addTo(map);

    const path = L.polyline([], {
      color: '#6fb3ff',
      weight: 5,
      opacity: 0.7,
      lineJoin: 'round',
    }).addTo(map);

    const ctx = document.getElementById('accChart').getContext('2d');

    const accChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Accel X (m/s²)',
            data: [],
            borderColor: '#ff6384',
            fill: false,
            tension: 0.35,
            pointRadius: 0,
          },
          {
            label: 'Accel Y (m/s²)',
            data: [],
            borderColor: '#36a2eb',
            fill: false,
            tension: 0.35,
            pointRadius: 0,
          },
          {
            label: 'Accel Z (m/s²)',
            data: [],
            borderColor: '#ffce56',
            fill: false,
            tension: 0.35,
            pointRadius: 0,
          },
        ],
      },
      options: {
        animation: {
          duration: 200,
          easing: 'easeOutQuart',
        },
        scales: {
          y: {
            beginAtZero: false,
            suggestedMin: -15,
            suggestedMax: 15,
            grid: { color: '#334466' },
            ticks: { color: '#a3c2ff' },
          },
          x: {
            grid: { color: '#334466' },
            ticks: { display: false },
          },
        },
        plugins: {
          legend: {
            labels: {
              color: '#a3c2ff',
              font: { weight: '600' },
            },
          },
          tooltip: {
            enabled: true,
            mode: 'nearest',
            intersect: false,
            backgroundColor: '#6fb3ffcc',
            titleColor: '#142a40',
            bodyColor: '#142a40',
          },
        },
        responsive: true,
        maintainAspectRatio: false,
      },
    });

    const loadingMsg = document.getElementById('loadingMsg');
    let connected = false;

    function update() {
      fetch(url)
        .then((r) => r.json())
        .then((d) => {
          if (!connected) {
            connected = true;
            loadingMsg.style.opacity = 0;
            setTimeout(() => (loadingMsg.style.display = 'none'), 500);
          }

          const ax = d.buffer.accX?.last || 0;
          const ay = d.buffer.accY?.last || 0;
          const az = d.buffer.accZ?.last || 0;
          const speed = d.buffer.speed?.last || 0;
          const lat = d.buffer.latitude?.last;
          const lon = d.buffer.longitude?.last;
          const heading = d.buffer.heading?.last || 0;

          document.getElementById('speedDisplay').innerText = speed.toFixed(1) + ' km/h';
          const leanAngle = Math.atan2(ax, 9.81) * (180 / Math.PI);
          document.getElementById('leanDisplay').innerText = leanAngle.toFixed(1) + '°';

          document.getElementById('accXDisplay').innerText = ax.toFixed(2);
          document.getElementById('accYDisplay').innerText = ay.toFixed(2);
          document.getElementById('accZDisplay').innerText = az.toFixed(2);

          document.getElementById('latDisplay').innerText = lat ? `Lat: ${lat.toFixed(5)}` : 'Lat: N/A';
          document.getElementById('lonDisplay').innerText = lon ? `Lon: ${lon.toFixed(5)}` : 'Lon: N/A';
          document.getElementById('compassDisplay').innerText = `Heading: ${heading.toFixed(0)}°`;

          // Update acceleration chart
          accChart.data.labels.push('');
          accChart.data.datasets[0].data.push(ax);
          accChart.data.datasets[1].data.push(ay);
          accChart.data.datasets[2].data.push(az);

          if (accChart.data.labels.length > 60) {
            accChart.data.labels.shift();
            accChart.data.datasets.forEach((ds) => ds.data.shift());
          }
          accChart.update();

          // Update map path and view
          if (lat && lon) {
            path.addLatLng([lat, lon]);
            map.setView([lat, lon], map.getZoom(), { animate: true, duration: 0.7 });
          }

          // Simple crash detection
          const IMPACT_THRESHOLD = 30.0;
          const GYRO_THRESHOLD = 250.0;
          const gyro = d.buffer.rotX?.last || 0;
          const res = Math.sqrt(ax * ax + ay * ay + az * az);

          if (res > IMPACT_THRESHOLD || Math.abs(gyro) > GYRO_THRESHOLD) {
            alert('⚠️ High impact detected! Save data and check rider.');
          }
        })
        .catch((e) => {
          if (connected) {
            connected = false;
            loadingMsg.style.display = 'block';
            loadingMsg.style.opacity = 1;
            loadingMsg.textContent = 'Connection lost. Retrying...';
          }
          console.error('Error fetching data:', e);
        });

      requestAnimationFrame(update);
    }

    update(); // Start update loop
  </script>
</body>
</html>


